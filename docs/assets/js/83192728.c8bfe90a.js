"use strict";(self.webpackChunkaqua_docusaurus=self.webpackChunkaqua_docusaurus||[]).push([[5737],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>m});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var s=a.createContext({}),p=function(e){var t=a.useContext(s),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(r),d=n,m=c["".concat(s,".").concat(d)]||c[d]||g[d]||i;return r?a.createElement(m,o(o({ref:t},u),{},{components:r})):a.createElement(m,o({ref:t},u))}));function m(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=r.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:n,o[1]=l;for(var p=2;p<i;p++)o[p]=r[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,r)}d.displayName="MDXCreateElement"},6370:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>g,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=r(7462),n=(r(7294),r(3905));const i={sidebar_position:447},o="Create Private Registries",l={unversionedId:"develop-registry/create-private-registry",id:"develop-registry/create-private-registry",title:"Create Private Registries",description:"If your GitHub organization has in-house tools,",source:"@site/docs/develop-registry/create-private-registry.md",sourceDirName:"develop-registry",slug:"/develop-registry/create-private-registry",permalink:"/docs/develop-registry/create-private-registry",draft:!1,editUrl:"https://github.com/aquaproj/aquaproj.github.io/edit/main/docs/develop-registry/create-private-registry.md",tags:[],version:"current",sidebarPosition:447,frontMatter:{sidebar_position:447},sidebar:"tutorialSidebar",previous:{title:"Registry Style Guide",permalink:"/docs/develop-registry/registry-style-guide"},next:{title:"Change GOOS and GOARCH for testing Registry",permalink:"/docs/develop-registry/change-os-arch-for-test"}},s={},p=[{value:"How to use",id:"how-to-use",level:2},{value:"Prepare a GitHub App or GitHub Personal Access Token for CI",id:"prepare-a-github-app-or-github-personal-access-token-for-ci",level:2},{value:"Renovate",id:"renovate",level:2},{value:"Automerge Renovate Pull Requests",id:"automerge-renovate-pull-requests",level:3},{value:"Contributing",id:"contributing",level:2},{value:"Requirements",id:"requirements",level:3},{value:"Set up",id:"set-up",level:3},{value:"How to add packages",id:"how-to-add-packages",level:3},{value:"Generate <code>version_overrides</code> by <code>--deep</code> option",id:"generate-version_overrides-by---deep-option",level:4},{value:"Getting Started",id:"getting-started",level:4}],u={toc:p},c="wrapper";function g(e){let{components:t,...r}=e;return(0,n.kt)(c,(0,a.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"create-private-registries"},"Create Private Registries"),(0,n.kt)("p",null,"If your GitHub organization has in-house tools,\nit is useful to create a private registry in your organization."),(0,n.kt)("p",null,"aqua provides the framework to build private registries."),(0,n.kt)("p",null,"The framework has the following components."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/registry-tool"},"registry-tool"),": CLI"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/template-private-aqua-registry"},"template repository")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/registry-action"},"registry-action"),": GitHub Actions")),(0,n.kt)("h2",{id:"how-to-use"},"How to use"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/new?template_name=template-private-aqua-registry&template_owner=aquaproj"},"Create a repository from the template repository")),(0,n.kt)("li",{parentName:"ol"},"Replace placeholders ",(0,n.kt)("inlineCode",{parentName:"li"},"<REPO_OWNER>")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"<REPO_NAME>")),(0,n.kt)("li",{parentName:"ol"},"Prepare a GitHub App or GitHub Personal Access Token for CI"),(0,n.kt)("li",{parentName:"ol"},"(Optional) Install Renovate App in the repository")),(0,n.kt)("h2",{id:"prepare-a-github-app-or-github-personal-access-token-for-ci"},"Prepare a GitHub App or GitHub Personal Access Token for CI"),(0,n.kt)("p",null,"To test the registry in CI, GitHub Access Token is required to access private repositories."),(0,n.kt)("p",null,"We recommend creating a GitHub App and install it to private repositories.\nYou can also use GitHub Personal Access Token instead of GitHub App."),(0,n.kt)("p",null,"Then please set GitHub App ID and Private Key or Personal Access Token at GitHub Secrets and fix GitHub Actions Workflow ",(0,n.kt)("inlineCode",{parentName:"p"},"test")," using secrets."),(0,n.kt)("p",null,"e.g."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-yaml"},'      - name: Generate token\n        id: generate_token\n        uses: tibdex/github-app-token@v1\n        with:\n          app_id: ${{ secrets.APP_ID }}\n          private_key: ${{ secrets.APP_PRIVATE_KEY }}\n\n      - uses: aquaproj/registry-action/test@v0.1.0\n        with:\n          goos: ${{ matrix.env.goos }}\n          goarch: ${{ matrix.env.goarch }}\n          go_version: "1.18.5"\n        env:\n          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}\n')),(0,n.kt)("h2",{id:"renovate"},"Renovate"),(0,n.kt)("p",null,"You can test tool updates in CI using Renovate.\nPlease install Renovate in repositories."),(0,n.kt)("h3",{id:"automerge-renovate-pull-requests"},"Automerge Renovate Pull Requests"),(0,n.kt)("p",null,"If you would like to automerge Renovate Pull Requests, please enable automerge."),(0,n.kt)("p",null,"ref. ",(0,n.kt)("a",{parentName:"p",href:"https://devs.quipper.com/2022/03/29/automate-handling-a-number-of-pull-requests-by-renovate-in-terraform-monorepo.html"},"2022-03-29 Automate handling a number of Pull Requests by Renovate in Terraform Monorepo")),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"Enable Automerge",(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},"Add the job ",(0,n.kt)("inlineCode",{parentName:"li"},"status-check")," to the default branch's branch protection rule's ",(0,n.kt)("inlineCode",{parentName:"li"},"Status checks that are required.")))),(0,n.kt)("li",{parentName:"ul"},"Enable platformAutomerge")),(0,n.kt)("h2",{id:"contributing"},"Contributing"),(0,n.kt)("h3",{id:"requirements"},"Requirements"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"/docs/install"},"aqua")," >= ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/aqua/releases/tag/v1.14.0"},"v1.14.0")),(0,n.kt)("li",{parentName:"ul"},"GitHub Access Token")),(0,n.kt)("p",null,"GitHub Access Token is required to access private repositories.\nPlease set your GitHub Access Token as the environment variable ",(0,n.kt)("inlineCode",{parentName:"p"},"GITHUB_TOKEN")," or ",(0,n.kt)("inlineCode",{parentName:"p"},"AQUA_GITHUB_TOKEN"),". The scope ",(0,n.kt)("inlineCode",{parentName:"p"},"repo")," is required."),(0,n.kt)("h3",{id:"set-up"},"Set up"),(0,n.kt)("p",null,"Checkout the repository and install ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/aquaproj/registry-tool"},"aqua-registry CLI"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-console"},"$ git checkout https://github.com/<REPO_OWNER>/<REPO_NAME>\n$ cd <REPO_NAME>\n$ aqua i -l # Install aqua-registry CLI\n")),(0,n.kt)("h3",{id:"how-to-add-packages"},"How to add packages"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Scaffold configuration: ",(0,n.kt)("inlineCode",{parentName:"li"},"aqua-registry scaffold [--deep] <package name>")),(0,n.kt)("li",{parentName:"ol"},"Fix generated files if the scaffold fails"),(0,n.kt)("li",{parentName:"ol"},"Update registry.yaml: ",(0,n.kt)("inlineCode",{parentName:"li"},"aqua-registry gr")),(0,n.kt)("li",{parentName:"ol"},"Test: ",(0,n.kt)("inlineCode",{parentName:"li"},"aqua i")," and run installed tools"),(0,n.kt)("li",{parentName:"ol"},"Repeat the step 2 ~ 4 until packages are installed properly"),(0,n.kt)("li",{parentName:"ol"},"Create a pull request: ",(0,n.kt)("inlineCode",{parentName:"li"},"aqua-registry create-pr-new-pkg <package name>..."))),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"Don't run ",(0,n.kt)("inlineCode",{parentName:"p"},"scaffold")," command against the same package at multiple times.")),(0,n.kt)("admonition",{type:"caution"},(0,n.kt)("p",{parentName:"admonition"},"When you update ",(0,n.kt)("inlineCode",{parentName:"p"},"pkgs/**/registry.yaml"),", you have to run ",(0,n.kt)("inlineCode",{parentName:"p"},"aqua-registry gr")," to reflect the update to ",(0,n.kt)("inlineCode",{parentName:"p"},"registry.yaml")," on the repository root directory.")),(0,n.kt)("h4",{id:"generate-version_overrides-by---deep-option"},"Generate ",(0,n.kt)("inlineCode",{parentName:"h4"},"version_overrides")," by ",(0,n.kt)("inlineCode",{parentName:"h4"},"--deep")," option"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"registry-tool >= v0.1.8 ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/registry-tool/pull/307"},"registry-tool#307")),(0,n.kt)("li",{parentName:"ul"},"aqua >= v1.34.0 ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/aqua/issues/1655"},"#1655")," ",(0,n.kt)("a",{parentName:"li",href:"https://github.com/aquaproj/aqua/pull/1662"},"#1662"))),(0,n.kt)("p",null,"By default, ",(0,n.kt)("inlineCode",{parentName:"p"},"aqua-registry scaffold")," doesn't generate ",(0,n.kt)("a",{parentName:"p",href:"/docs/reference/registry-config/version-overrides/"},"version_constraint and version_overrides"),".\nYou can generate them by ",(0,n.kt)("inlineCode",{parentName:"p"},"--deep")," option.\n",(0,n.kt)("inlineCode",{parentName:"p"},"aqua-registry scaffold --deep")," calls ",(0,n.kt)("inlineCode",{parentName:"p"},"aqua gr --deep")," internally."),(0,n.kt)("p",null,"Please see ",(0,n.kt)("a",{parentName:"p",href:"/docs/develop-registry/scaffold-registry#generate-version_overrides-by---deep-option"},"here")," too."),(0,n.kt)("h4",{id:"getting-started"},"Getting Started"),(0,n.kt)("p",null,"Let's try to add ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/BurntSushi/ripgrep"},"BurntSushi/ripgrep")," to the registry."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-console"},'$ aqua-registry scaffold BurntSushi/ripgrep\n+ aqua gr BurntSushi/ripgrep\n >> registry.yamlUpdate registry.yaml\nCreating aqua-local.yaml\n+ aqua g local,BurntSushi/ripgrep >> aqua-local.yaml\n+ aqua g pkgs/BurntSushi/ripgrep/pkg.yaml >> BurntSushi/ripgrep\n+ aqua i --test\nINFO[0000] create a symbolic link                        aqua_version=1.19.2 env=darwin/arm64 link_file=/Users/shunsukesuzuki/.local/share/aquaproj-aqua/bin/ripgrep new=aqua-proxy program=aqua\nERRO[0000] install the package                           aqua_version=1.19.2 env=darwin/arm64 error="check file_src is correct: exe_path isn\'t found: stat /Users/shunsukesuzuki/.local/share/aquaproj-aqua/pkgs/github_release/github.com/BurntSushi/ripgrep/13.0.0/ripgrep-13.0.0-x86_64-apple-darwin.tar.gz/ripgrep: no such file or directory" file_name=ripgrep package_name=BurntSushi/ripgrep package_version=13.0.0 program=aqua registry=local\nFATA[0000] aqua failed                                   aqua_version=1.19.2 env=darwin/arm64 error="it failed to install some packages" program=aqua\nFATA[0001] aqua failed                                   aqua_version=0.1.0-1 env=darwin/arm64 error="execute a command: aqua i: exit status 1" program=aqua-registry\n')),(0,n.kt)("p",null,"When the scaffold fails, please see the log."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"check file_src is correct: exe_path isn't found: stat /Users/shunsukesuzuki/.local/share/aquaproj-aqua/pkgs/github_release/github.com/BurntSushi/ripgrep/13.0.0/ripgrep-13.0.0-x86_64-apple-darwin.tar.gz/ripgrep: no such file or directory\n")),(0,n.kt)("p",null,"\ud83d\udca1 ",(0,n.kt)("a",{parentName:"p",href:"/docs/trouble-shooting#check-file_src-is-correct"},"Troubleshooting: check file_src is correct")),(0,n.kt)("p",null,"Fix the configuration pkgs/BurntSushi/ripgrep/registry.yaml like ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/aquaproj/aqua-registry/blob/main/pkgs/BurntSushi/ripgrep/registry.yaml"},"this"),"."),(0,n.kt)("p",null,"Then run ",(0,n.kt)("inlineCode",{parentName:"p"},"aqua-registry gr")," and ",(0,n.kt)("inlineCode",{parentName:"p"},"aqua i"),"."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-console"},"$ aqua-registry gr\n$ aqua i\n")),(0,n.kt)("p",null,"Check the log and fix the following configuration files as needed."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"pkgs/BurntSushi/ripgrep/pkg.yaml"),(0,n.kt)("li",{parentName:"ul"},"pkgs/BurntSushi/ripgrep/registry.yaml"),(0,n.kt)("li",{parentName:"ul"},"aqua-test.yaml")),(0,n.kt)("p",null,"Run ",(0,n.kt)("inlineCode",{parentName:"p"},"rg --help")," for testing."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-console"},"$ rg --help\n")),(0,n.kt)("p",null,"If it doesn't work, check the log and fix the above configuration files."),(0,n.kt)("p",null,"When it works well, please create a pull request."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-console"},"$ aqua-registry create-pr-new-pkg BurntSushi/ripgrep\n")))}g.isMDXComponent=!0}}]);