---
name: Updat yarn.lock

on:
  workflow_call:
    secrets:
      APP_ID:
        required: false
      PRIVATE_KEY:
        required: false

jobs:
  update-yarn-lock:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          ref: ${{github.event.pull_request.head.sha}}
      - name: get nested property
        id: package_json
        uses: notiz-dev/github-action-json-property@a5a9c668b16513c737c3e1f8956772c99c73f6e8 # v0.2.0
        with: 
          path: package.json
          prop_path: volta.node
      - uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65 # v4.0.0
        with:
          node-version: ${{steps.package_json.outputs.prop}}
          cache: 'yarn'
      - run: yarn install

      - uses: aquaproj/aqua-installer@36dc5833b04eb63f06e3bb818aa6b7a6e6db99a9 # v2.1.2
        # Install ghcp
        with:
          aqua_version: v2.16.1
        env:
          AQUA_GITHUB_TOKEN: ${{github.token}}

      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        with:
          app_id: ${{secrets.APP_ID}}
          private_key: ${{secrets.PRIVATE_KEY}}

      - name: update yarn.lock
        env:
          GITHUB_TOKEN: ${{steps.generate_token.outputs.token}}
        run: |
          if git diff --quiet yarn.lock; then
            exit 0
          fi
          if ! ghcp -v; then
            echo "::error ::int128/ghcp isn't installed. To push a commit, ghcp is required."
            exit 1
          fi
          ghcp commit -r "$GITHUB_REPOSITORY" -b "$GITHUB_HEAD_REF" \
            -m "chore: update yarn.lock" \
            yarn.lock
          exit 1
